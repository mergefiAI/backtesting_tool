# 用户使用手册

## 版本信息

- **文档版本**: v1.1
- **更新日期**: 2025-12-31
- **维护团队**: AI交易策略系统开发团队

## 1. 系统概述

AI交易策略回测系统是一款基于人工智能技术的量化交易回测平台。系统支持用户创建交易策略、配置AI模型、执行回测任务，并提供详细的回测分析和可视化报告。

系统采用前后端分离架构，前端使用React 18 + TypeScript构建，后端使用FastAPI框架，数据库使用SQLite存储。系统支持股票和加密货币市场的回测模拟，通过AI决策引擎生成交易信号，实现自动化回测分析。

## 2. 环境要求

### 2.1 运行环境要求

系统运行需要以下基础环境配置。操作系统支持Windows、macOS和Linux等主流操作系统。硬件配置建议为2核以上CPU、4GB以上内存、20GB以上磁盘空间。网络环境需要能够访问Docker Hub或配置了国内镜像加速器。

### 2.2 本地开发环境要求

如果需要在本地进行开发调试，除了上述运行环境外，还需要安装Node.js 18+、Python 3.10+、Git等开发工具。建议使用虚拟环境管理Python依赖，使用pnpm或npm管理前端依赖。

## 3. 部署系统

### 3.1 快速部署步骤

1. **克隆仓库**

   ```bash
   git clone <仓库地址>
   cd backtesting_tool
   ```

2. **配置环境变量**

   ```bash
   cp cfg/.env.sqlite .env
   ```

3. **启动服务**

   ```bash
   # 启动开发环境服务
   docker-compose up -d
   ```

4. **验证服务**

   服务启动后，可以通过以下地址访问系统：

   - 前端应用：http://localhost:5173
   - API文档：http://localhost:8000/docs
   - 健康检查：http://localhost:8000/health

### 3.2 本地开发启动

如需进行本地开发调试，可以分别启动前端和后端服务。

**启动后端服务**：

```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows系统使用: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 启动后端服务
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**启动前端服务**：

```bash
# 安装依赖
cd frontend
pnpm install  # 或 npm install

# 启动开发服务器
pnpm dev
```

### 3.3 Docker部署配置

Docker Compose配置文件位于项目根目录的`docker-compose.yml`文件中。默认配置会启动前后端服务，并通过端口映射暴露服务。

如果需要修改配置，可以编辑`.env`文件或`docker-compose.yml`文件。常见配置项包括端口映射、数据卷挂载、环境变量等。

## 4. 导航菜单说明

系统左侧导航菜单按照功能模块组织，包含以下主要功能入口：

### 4.1 顶部主导航

- **创建策略**：策略模板管理页面，用于创建和管理AI交易策略
- **回测列表**：回测结果展示页面，显示K线图表和回测任务信息
- **策略回测**：回测任务管理页面，用于创建和管理回测任务
- **数据仓库**：数据管理模块，包含数据导入、趋势导入和市场数据管理功能
- **AI配置**：AI服务配置页面，用于管理本地AI模型连接配置
- **其他**：辅助功能模块，包含账户列表、快照列表、本地决策、决策关联数据和交易列表

### 4.2 页面访问地址

| 功能 | 路由地址 | 描述 |
|------|----------|------|
| 创建策略 | /prompt-templates | 管理策略模板 |
| 回测列表 | /dashboard/kline | 查看回测结果和K线图表 |
| 策略回测 | /tasks | 管理回测任务 |
| 数据导入 | /data-import | 导入市场数据 |
| 趋势导入 | /trend-import | 导入趋势数据 |
| 市场数据管理 | /market/data-manager | 管理已导入的市场数据 |
| AI配置 | /ai-configs | 配置AI服务连接 |
| 账户列表 | /accounts/list | 查看虚拟账户 |
| 快照列表 | /snapshots | 查看账户快照 |
| 本地决策 | /local-decision/list | 查看本地决策记录 |
| 决策关联数据 | /decision/related-data | 查看决策关联数据 |
| 交易列表 | /trades | 查看交易记录 |

系统首页默认跳转到创建策略页面。如需修改默认首页，可以在路由配置中修改`index`路由的跳转目标。

## 5. AI配置

在使用AI进行策略回测之前，需要先配置AI服务连接。系统支持配置本地运行的AI服务（如Ollama、LocalAI等）。

### 5.1 添加AI配置

1. 在左侧导航菜单中点击**AI配置**
2. 进入AI配置管理页面
3. 点击**创建AI配置**按钮
4. 填写AI配置信息：
   - **配置名称**：为该配置设置一个易于识别的名称
   - **本地AI基础URL**：AI服务的API地址，如http://localhost:11434
   - **本地AI API Key**：AI服务的访问密钥（如Ollama不需要可留空）
   - **本地AI模型名称**：使用的模型名称，如llama3、qwen2等
5. 点击**保存**按钮
6. 系统提示AI配置创建成功

### 5.2 修改AI配置

1. 在AI配置列表中找到要修改的配置
2. 点击操作列中的**编辑**按钮
3. 修改配置信息
4. 点击**保存**按钮

### 5.3 删除AI配置

1. 在AI配置列表中找到要删除的配置
2. 点击操作列中的**删除**按钮
3. 确认删除操作

注意：删除AI配置前，请确保没有回测任务正在使用该配置。

## 6. 创建策略

策略模板是AI决策引擎生成交易信号的基础。一个完整的策略模板包含角色定义、数据输入格式、交易规则、分析逻辑和输出格式等内容。

### 6.1 创建策略模板

1. 在左侧导航菜单中点击**创建策略**
2. 进入策略模板管理页面
3. 点击**创建策略**按钮
4. 填写策略信息：
   - **策略内容**：编写完整的提示词内容，定义AI的角色、任务和输出格式
   - **策略描述**：简要描述该策略的用途和特点
   - **策略状态**：选择策略的启用状态
   - **策略标签**：为策略添加标签，便于分类管理
5. 点击**保存**按钮
6. 系统提示策略创建成功

### 6.2 策略内容编写指南

策略内容的质量直接影响AI决策的效果。编写策略时应包含以下要素：

- **角色定义**：明确AI扮演的专业角色，如专业交易员、量化分析师等
- **数据输入**：说明AI需要分析的数据类型和格式，如K线数据、技术指标等
- **分析逻辑**：描述决策分析的方法和思路
- **交易规则**：定义买入、卖出、持有的条件和优先级
- **输出格式**：规定AI输出的格式，便于程序解析

### 6.3 管理策略模板

在策略模板管理页面，可以进行以下操作：

- **查看详情**：点击策略记录查看完整内容
- **编辑修改**：点击编辑按钮修改策略信息
- **启用/禁用**：修改策略的启用状态
- **删除策略**：删除不需要的策略模板

## 7. 数据管理

在进行回测之前，需要先导入市场数据。系统支持导入日线、小时线、分钟线等不同时间粒度的市场数据。

### 7.1 数据导入

1. 在左侧导航菜单中点击**数据仓库**，然后点击**数据导入**
2. 进入数据导入页面
3. 点击**上传文件**按钮，选择CSV格式的数据文件
4. 系统会自动解析文件并显示数据预览
5. 确认列映射关系正确后，点击**执行导入**按钮
6. 导入完成后，系统显示导入结果

CSV文件格式要求：第一行为列标题，包含日期、开盘价、最高价、最低价、收盘价、成交量等字段。日期格式支持YYYY-MM-DD。

### 7.2 趋势导入

趋势数据用于辅助AI进行趋势判断。系统支持导入Excel或CSV格式的趋势数据。

1. 在左侧导航菜单中点击**数据仓库**，然后点击**趋势导入**
2. 进入趋势导入页面
3. 上传趋势数据文件
4. 系统预览数据并验证格式
5. 点击**执行导入**按钮

趋势数据格式支持两种方式：单列格式（日期和趋势用空格分隔）和双列格式（date列和trend列）。

### 7.3 市场数据管理

在市场数据管理页面，可以查看已导入的市场数据并进行管理操作。

1. 在左侧导航菜单中点击**数据仓库**，然后点击**市场数据管理**
2. 进入市场数据管理页面
3. 可以查看各标的的数据量统计
4. 支持按时间粒度筛选查看
5. 可以删除不需要的数据

## 8. 创建回测任务

回测任务是系统执行策略模拟的核心载体。一个回测任务关联了策略模板、AI配置、虚拟账户和回测时间范围。

### 8.1 创建回测任务

1. 在左侧导航菜单中点击**策略回测**
2. 进入回测任务管理页面
3. 点击**创建策略**按钮
4. 填写回测任务信息：
   - **任务名称**：为回测任务设置名称
   - **虚拟账户**：选择用于回测的虚拟账户
   - **股票代码**：设置回测的标的，如BTC、ETH等
   - **开始日期**：回测的时间范围起点
   - **结束日期**：回测的时间范围终点
   - **时间粒度**：选择日线、小时线或分钟线
   - **决策间隔**：设置决策执行频率
   - **AI配置**：选择用于决策的AI配置
   - **策略**：选择使用的策略模板
5. 点击**保存**按钮
6. 系统提示回测任务创建成功

### 8.2 管理回测任务

在回测任务管理页面，可以进行以下操作：

- **启动任务**：启动处于暂停或就绪状态的任务
- **暂停任务**：暂停正在运行的任务
- **恢复任务**：恢复被暂停的任务
- **停止任务**：停止正在运行的任务
- **查看日志**：查看任务执行的详细日志
- **删除任务**：删除不需要的任务

### 8.3 任务状态说明

回测任务有以下状态：

- **待执行（PENDING）**：任务已创建，等待启动
- **运行中（RUNNING）**：任务正在执行回测
- **已暂停（PAUSED）**：任务被暂停，可以恢复
- **已完成（COMPLETED）**：任务正常完成
- **部分完成（COMPLETED_WITH_ERRORS）**：任务完成但有部分错误
- **已失败（FAILED）**：任务执行失败
- **已取消（CANCELLED）**：任务被手动取消

## 9. 查看回测结果

回测任务完成后，可以在回测列表页面查看详细的回测结果和数据分析。

### 9.1 回测列表

1. 在左侧导航菜单中点击**回测列表**
2. 进入回测结果展示页面
3. 页面显示所有回测任务的列表
4. 可以使用搜索功能查找特定任务
5. 可以使用筛选功能按状态、时间等条件筛选

### 9.2 K线图表展示

在回测列表页面，选择一个回测任务可以查看K线图表和资金曲线。

K线图表区域显示以下信息：

- **K线图**：显示标的的价格走势
- **资产净值曲线**：显示账户总资产变化
- **收益率曲线**：显示相对初始资金的比例变化
- **持仓状态**：标记买入和卖出的时间点

### 9.3 回测统计指标

回测结果页面展示以下关键统计指标：

- **总收益率**：回测期间的总收益率
- **年化收益率**：折算为年化的收益率
- **夏普比率**：风险调整后的收益指标
- **最大回撤**：资金从峰值到谷底的最大跌幅
- **胜率**：盈利交易占总交易的比例
- **盈亏比**：平均盈利与平均亏损的比值
- **总交易次数**：完成的交易总数

### 9.4 本地决策列表

1. 在左侧导航菜单中点击**其他**，然后点击**本地决策**
2. 进入本地决策记录页面
3. 显示所有AI生成的决策记录
4. 可以查看每次决策的详细信息：
   - 决策时间
   - 决策结果（买入、卖出、持有）
   - 置信度评分
   - 决策理由

### 9.5 账户快照

1. 在左侧导航菜单中点击**其他**，然后点击**快照列表**
2. 进入账户快照页面
3. 显示所有账户快照记录
4. 每个快照包含：
   - 快照时间
   - 账户余额
   - 持仓数量
   - 持仓市值
   - 累计盈亏
5. 支持导出快照数据

### 9.6 交易记录

1. 在左侧导航菜单中点击**其他**，然后点击**交易列表**
2. 进入交易记录页面
3. 显示所有模拟交易记录
4. 每条记录包含：
   - 交易时间
   - 交易类型（买入、卖出）
   - 交易价格
   - 交易数量
   - 交易金额
   - 佣金费用
5. 支持按时间、类型等条件筛选
6. 支持导出交易记录

### 9.7 决策关联数据

1. 在左侧导航菜单中点击**其他**，然后点击**决策关联数据**
2. 进入决策关联数据页面
3. 显示决策时使用的K线关联数据
4. 可以查看决策生成的详细分析过程

## 10. 账户管理

### 10.1 账户列表

1. 在左侧导航菜单中点击**其他**，然后点击**账户列表**
2. 进入虚拟账户管理页面
3. 显示所有虚拟账户信息
4. 每个账户包含：
   - 账户ID
   - 初始余额
   - 当前余额
   - 持仓数量
   - 持仓市值
   - 总资产价值

### 10.2 账户配置

虚拟账户支持配置以下参数：

- **初始余额**：账户的初始资金
- **买入佣金率**：买入交易的手续费比例
- **卖出佣金率**：卖出交易的手续费比例
- **印花税率**：卖出交易时的印花税比例
- **最低佣金**：每笔交易的最低手续费

## 11. 常见问题

### 11.1 部署问题

**问题：启动服务时提示端口被占用**

解决方案：首先检查端口占用情况，确认哪个进程占用了目标端口。可以停止占用端口的进程，或者修改docker-compose配置文件中的端口映射，将服务映射到其他端口。

**问题：无法拉取Docker镜像**

解决方案：检查网络连接，确保能够访问Docker Hub。如果网络访问受限，可以配置Docker国内镜像加速器。在Docker设置中配置镜像加速器后，重启Docker服务。

### 11.2 配置问题

**问题：AI配置保存后不生效**

解决方案：请检查以下几点：确认配置文件是否正确保存；重启后端服务使配置生效；查看系统日志排查配置错误；确认AI服务是否正常运行。

**问题：策略保存后无法在回测中选择**

解决方案：请检查以下几点：确认策略状态是否为启用；检查策略的市场类型和股票代码是否与回测任务匹配；刷新页面重新加载策略列表；确认策略是否保存成功。

### 11.3 回测问题

**问题：回测任务启动后立即失败**

解决方案：请按以下步骤排查：检查回测参数配置是否正确完整；检查K线数据是否完整且时间范围正确；查看回测日志获取具体错误信息；确认AI服务是否正常运行。

**问题：回测过程中出现超时**

解决方案：可以尝试以下方法：缩短回测周期，减少数据量；检查系统资源是否充足；增加任务超时配置；分批次执行回测任务。

### 11.4 数据问题

**问题：K线数据导入失败**

解决方案：请检查以下几点：确认CSV文件格式是否正确；检查数据文件内容是否完整无损坏；查看导入日志获取具体错误原因；确认日期格式是否符合要求。

**问题：K线数据显示不完整**

解决方案：请按以下步骤操作：检查数据导入是否成功完成；检查数据的时间范围配置是否正确；确认数据粒度与回测设置一致；必要时重新导入数据。

## 12. 技术支持

如果您在使用过程中遇到问题或有任何建议，可以通过以下方式获取支持：

- **项目文档**：查看docs目录下的其他文档获取详细说明
- **API文档**：访问http://localhost:8000/docs查看接口文档
- **源码分析**：通过IDE阅读源码了解系统实现
- **日志查看**：通过后端日志排查问题原因

## 附录A：配置项说明

### A.1 环境变量配置

系统支持通过`.env`文件配置以下环境变量：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| DATABASE_URL | 数据库连接字符串 | sqlite:///backtesting_dev.db |
| DEBUG | 调试模式开关 | false |
| LOG_LEVEL | 日志级别 | INFO |

### A.2 AI配置说明

系统支持的AI服务配置参数：

| 参数 | 说明 | 示例 |
|------|------|------|
| base_url | AI服务API地址 | http://localhost:11434 |
| api_key | API访问密钥 | （根据服务类型设置） |
| model | 模型名称 | llama3、qwen2等 |

## 附录B：数据格式规范

### B.1 K线数据格式

系统支持的K线数据CSV格式：

```csv
date,open,high,low,close,volume
2025-01-01,45000.00,45500.00,44800.00,45200.00,1000000
```

字段说明：date为日期，open为开盘价，high为最高价，low为最低价，close为收盘价，volume为成交量。所有价格和数量字段保留8位小数精度。

### B.2 趋势数据格式

系统支持两种趋势数据格式：

**单列格式**（日期和趋势用空格分隔）：

```
2025年1月1日 上升
2025年1月2日 下降
```

**双列格式**（date和trend两列）：

```csv
date,trend
2025-01-01,上升
2025-01-02,下降
```

趋势类型支持：上升、下降、震荡、横盘。

---

**文档版本**: v1.1  
**更新日期**: 2025-12-31  
**维护团队**: AI交易策略系统开发团队
